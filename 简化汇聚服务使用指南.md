# 简化汇聚服务使用指南

## 概述

简化汇聚服务是一个专门处理教育统计数据的模块化系统，支持区域级和学校级数据汇聚，特别针对问卷数据提供了专业的处理能力。

## 核心组件

### 1. 问卷数据处理器 (`QuestionnaireProcessor`)

**位置**: `app/services/questionnaire_processor.py`

**功能特点**:
- 支持3种量表类型：4级量表、5级李克特量表、10分满意度量表
- 支持正向/反向量表自动转换
- 精确计算选项分布百分比（保留2位小数）
- 维度级和题目级选项占比统计

**支持的量表类型**:

| 量表类型 | 枚举值 | 转换规则 | 示例标签 |
|---------|--------|----------|----------|
| 4级量表-正向 | `SCALE_4_POSITIVE` | 1→1, 2→2, 3→3, 4→4 | 不同意, 基本同意, 同意, 非常同意 |
| 4级量表-反向 | `SCALE_4_NEGATIVE` | 1→4, 2→3, 3→2, 4→1 | 不同意, 基本同意, 同意, 非常同意 |
| 5级李克特量表 | `SCALE_5_LIKERT` | 1→1, 2→2, 3→3, 4→4, 5→5 | 非常不满意, 不满意, 一般, 满意, 非常满意 |
| 5级李克特量表-反向 | `SCALE_5_LIKERT_NEG` | 1→5, 2→4, 3→3, 4→2, 5→1 | 非常不满意, 不满意, 一般, 满意, 非常满意 |
| 10分满意度量表 | `SCALE_10_SATISFACTION` | 1→1, 2→2, ..., 10→10 | 1分, 2分, ..., 10分 |

**使用示例**:

```python
from app.services.questionnaire_processor import QuestionnaireProcessor, QuestionnaireConfig, ScaleType
import pandas as pd

# 初始化处理器
processor = QuestionnaireProcessor()

# 创建问卷配置
config = QuestionnaireConfig(
    scale_type=ScaleType.SCALE_5_LIKERT,
    question_id='Q001',
    question_name='您对当前课程感兴趣吗？',
    dimension_code='INTEREST',
    dimension_name='学习兴趣'
)

# 处理问卷数据
data = pd.DataFrame({
    'student_id': ['S001', 'S002', 'S003'],
    'question_id': ['Q001', 'Q001', 'Q001'],
    'raw_score': [5, 4, 3],
    'dimension_code': ['INTEREST', 'INTEREST', 'INTEREST'],
    'dimension_name': ['学习兴趣', '学习兴趣', '学习兴趣']
})

result = processor.process_questionnaire_data(data, [config], "BATCH-001")
```

### 2. 简化汇聚服务 (`SimplifiedAggregationService`)

**位置**: `app/services/simplified_aggregation_service.py`

**功能特点**:
- 区域级和学校级数据汇聚
- 考试科目和问卷科目混合处理
- 学校排名和区域排名计算
- 维度统计和问卷维度统计
- 支持批量处理多个批次

**主要方法**:

```python
from app.services.simplified_aggregation_service import SimplifiedAggregationService

service = SimplifiedAggregationService(db_session)

# 区域级汇聚
regional_result = service.aggregate_batch_regional(
    batch_code="G7-2025",
    progress_callback=lambda p, msg: print(f"{p}%: {msg}")
)

# 学校级汇聚
school_result = service.aggregate_batch_school(
    batch_code="G7-2025",
    school_id="S001",
    school_name="第一中学"
)

# 批量处理
batch_result = service.aggregate_all_batches(
    batch_codes=["G7-2025", "G8-2025"]
)
```

### 3. 数据持久化仓库 (`SimplifiedAggregationRepository`)

**位置**: `app/repositories/simplified_aggregation_repository.py`

**功能特点**:
- 汇聚数据的保存和读取
- 计算状态管理
- 历史记录追踪
- 批次状态查询

**主要方法**:

```python
from app.repositories.simplified_aggregation_repository import SimplifiedAggregationRepository
from app.database.models import AggregationLevel, CalculationStatus

repository = SimplifiedAggregationRepository(db_session)

# 保存汇聚数据
save_result = repository.save_aggregation_data(
    batch_code="G7-2025",
    aggregation_level=AggregationLevel.REGIONAL,
    data=regional_data,
    calculation_duration=30.5
)

# 读取汇聚数据
data = repository.get_aggregation_data(
    batch_code="G7-2025",
    aggregation_level=AggregationLevel.REGIONAL
)

# 更新状态
repository.update_aggregation_status(
    batch_code="G7-2025",
    aggregation_level=AggregationLevel.REGIONAL,
    status=CalculationStatus.COMPLETED
)

# 获取批次状态
status = repository.get_batch_aggregation_status("G7-2025")
```

## 数据结构规范

### 输入数据格式

系统期望的输入数据格式：

```sql
-- 学生分数详细数据表结构
CREATE TABLE student_score_detail (
    student_id VARCHAR(100),    -- 学生ID
    subject_id VARCHAR(64),     -- 科目ID
    question_id VARCHAR(64),    -- 题目ID（问卷时使用）
    raw_score DECIMAL(8,2),     -- 原始分数
    school_id VARCHAR(50),      -- 学校ID
    batch_code VARCHAR(50),     -- 批次代码
    -- 其他字段...
);

-- 科目题目配置表
CREATE TABLE subject_question_config (
    subject_id VARCHAR(64),
    question_id VARCHAR(64),
    subject_name VARCHAR(100),
    subject_type ENUM('exam', 'questionnaire'),
    max_score DECIMAL(8,2)
);

-- 题目维度映射表
CREATE TABLE question_dimension_mapping (
    question_id VARCHAR(64),
    dimension_code VARCHAR(50),
    dimension_name VARCHAR(100)
);
```

### 输出数据格式

#### 区域级汇聚数据

```json
{
    "batch_code": "G7-2025",
    "aggregation_level": "REGIONAL",
    "total_schools": 120,
    "total_students": 15200,
    "subjects": {
        "SUBJ_001": {
            "subject_id": "SUBJ_001",
            "subject_name": "语文",
            "subject_type": "exam",
            "metrics": {
                "avg_score": 85.62,
                "difficulty": 0.86,
                "std_dev": 12.35,
                "discrimination": 0.42,
                "max_score": 100.00,
                "min_score": 45.00,
                "p10": 70.00,
                "p50": 86.00,
                "p90": 95.00,
                "student_count": 15200
            },
            "ranking": {
                "school_rankings": [
                    {
                        "school_id": "5001",
                        "school_name": "一中",
                        "avg_score": 92.30,
                        "rank": 1
                    }
                ]
            },
            "dimensions": {
                "YW-jc": {
                    "avg_score": 28.50,
                    "score_rate": 85.50,
                    "rank": null,
                    "student_count": 15200
                }
            }
        },
        "SUBJ_WJ": {
            "subject_id": "SUBJ_WJ",
            "subject_name": "问卷",
            "subject_type": "questionnaire",
            "metrics": {
                "avg_score": 3.85,
                "difficulty": 0.77,
                "std_dev": 0.95,
                "discrimination": 0.38,
                "max_score": 5.00,
                "min_score": 1.00,
                "p10": 2.80,
                "p50": 3.90,
                "p90": 4.80,
                "student_count": 1074
            },
            "questionnaire_dimensions": [
                {
                    "dimension_code": "CZL-hqx",
                    "dimension_name": "好奇心",
                    "avg_score": 3.75,
                    "score_rate": 75.00,
                    "rank": 1,
                    "dimension_option_distributions": [
                        {
                            "option_label": "非常满意",
                            "count": 320,
                            "percentage": 29.80
                        }
                    ],
                    "questions": [
                        {
                            "question_id": "Q001",
                            "question_name": "您对课堂互动满意吗",
                            "option_distributions": [
                                {
                                    "option_label": "非常满意",
                                    "count": 120,
                                    "percentage": 11.17
                                }
                            ]
                        }
                    ],
                    "student_count": 1074
                }
            ]
        }
    },
    "created_at": "2025-01-07T10:30:00",
    "updated_at": "2025-01-07T10:30:00",
    "data_version": "2.0"
}
```

#### 学校级汇聚数据

学校级数据结构与区域级类似，但包含：
- `school_id` 和 `school_name` 字段
- `ranking` 中包含 `regional_rank`（在区域内的排名）
- 不包含 `school_rankings` 列表

## API集成示例

### 基本用法

```python
from fastapi import FastAPI, Depends
from sqlalchemy.orm import Session
from app.database.connection import get_db_session
from app.services.simplified_aggregation_service import SimplifiedAggregationService

app = FastAPI()

@app.post("/aggregate/regional")
async def aggregate_regional(
    batch_code: str,
    db: Session = Depends(get_db_session)
):
    service = SimplifiedAggregationService(db)
    result = service.aggregate_batch_regional(batch_code)
    return result
```

### 完整API示例

参考 `api_integration_example.py` 文件，包含：
- 区域级汇聚API
- 学校级汇聚API
- 批量处理API
- 数据查询API
- 状态管理API

## 测试和验证

### 运行组件测试

```bash
python test_simplified_components.py
```

这将测试：
- 问卷处理器的所有量表类型
- 汇聚服务的结构完整性
- 数据仓库的基本功能
- 数据模式的正确性
- 工具函数的精度

### 运行集成测试

```bash
python test_simplified_aggregation.py
```

这将测试：
- 与真实数据库的集成
- 完整的数据流程
- 错误处理机制

## 性能特点

### 处理能力
- 单批次支持10万学生数据
- 问卷选项分布计算优化
- 内存友好的数据处理
- 支持并发批次处理

### 数据精度
- 百分比计算保留2位小数
- 教育统计指标符合行业标准
- 量表转换准确无误
- 排名计算精确

## 扩展指南

### 添加新的量表类型

1. 在 `ScaleType` 枚举中添加新类型
2. 在 `OPTION_LABELS` 中定义选项标签
3. 在 `SCALE_TRANSFORMATIONS` 中定义转换规则
4. 更新 `get_max_score` 方法

### 自定义汇聚逻辑

1. 继承 `SimplifiedAggregationService`
2. 重写相关的计算方法
3. 添加新的数据验证规则
4. 扩展数据模式定义

### 集成新的统计算法

1. 在计算引擎中注册新的策略
2. 更新数据模式以支持新指标
3. 修改序列化器处理新字段
4. 添加相应的测试用例

## 故障排查

### 常见问题

1. **数据库连接问题**
   - 检查数据库配置
   - 确认网络连接
   - 验证用户权限

2. **数据格式不匹配**
   - 检查输入数据结构
   - 确认字段命名一致
   - 验证数据类型

3. **计算结果异常**
   - 检查满分配置
   - 验证原始数据质量
   - 确认量表类型设置

4. **性能问题**
   - 优化数据库查询
   - 调整批处理大小
   - 监控内存使用

### 日志分析

系统提供详细的日志输出：
- 处理进度信息
- 错误详情和堆栈
- 性能统计数据
- 数据质量警告

### 调试建议

1. 先运行组件测试确保基础功能正常
2. 使用小批量数据进行调试
3. 检查数据库表结构和数据质量
4. 逐步增加处理批次大小

## 版本历史

- **v2.0** - 简化汇聚服务实现
  - 问卷数据特殊处理
  - 区域级和学校级汇聚
  - 数据持久化仓库
  - 完整的API集成

---

*本文档涵盖了简化汇聚服务的完整使用指南。如有疑问，请参考测试文件或联系开发团队。*