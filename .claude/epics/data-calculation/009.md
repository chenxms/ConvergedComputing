---
name: 任务管理API
status: open
created: 2025-09-04T19:20:00Z
updated: 2025-09-04T19:20:00Z
github: [Will be updated when synced to GitHub]
depends_on: [003]
parallel: true
conflicts_with: []
---

# Task: 任务管理API

## Description
构建完整的统计任务管理RESTful API系统，提供批次管理、任务状态查询、手动触发、进度追踪等核心功能。支持异步任务处理、状态实时更新、错误恢复等企业级特性，为前端提供完整的任务管控界面支持。

## Acceptance Criteria
- [ ] 实现批次CRUD接口：创建、查询、更新、删除统计批次
- [ ] 实现任务状态管理：pending、processing、completed、failed状态流转
- [ ] 支持手动触发统计：手动启动指定批次的统计计算
- [ ] 提供进度查询接口：实时查询任务执行进度和状态
- [ ] 实现任务取消功能：支持正在执行任务的安全取消
- [ ] 支持批量操作：批量启动、停止、删除多个统计任务

## Technical Details
- RESTful设计：标准HTTP方法和状态码的API设计
- 异步处理：基于队列系统的异步任务执行
- 状态管理：任务状态的原子性更新和一致性保证
- 进度追踪：任务执行进度的实时计算和反馈
- 错误处理：异常情况的捕获、记录和恢复机制
- 涉及文件：app/Http/Controllers/StatisticsTaskController.php, app/Services/TaskManager/TaskStatusManager.php

## API Endpoints
```php
// 批次管理接口
POST   /api/v1/statistics/batches              // 创建新的统计批次
GET    /api/v1/statistics/batches              // 查询批次列表
GET    /api/v1/statistics/batches/{batch_code} // 查询指定批次信息  
PUT    /api/v1/statistics/batches/{batch_code} // 更新批次信息
DELETE /api/v1/statistics/batches/{batch_code} // 删除批次

// 任务管理接口
POST   /api/v1/statistics/tasks/{batch_code}/start    // 手动启动统计任务
POST   /api/v1/statistics/tasks/{batch_code}/cancel   // 取消执行中的任务
GET    /api/v1/statistics/tasks/{task_id}/status      // 查询任务状态
GET    /api/v1/statistics/tasks/{task_id}/progress    // 查询任务进度

// 批量操作接口
POST   /api/v1/statistics/tasks/batch-start           // 批量启动任务
POST   /api/v1/statistics/tasks/batch-cancel          // 批量取消任务
POST   /api/v1/statistics/tasks/batch-delete          // 批量删除任务
```

## Request/Response Format
```php
// 创建批次请求
{
    "batch_code": "BATCH_2025_001", 
    "description": "2025年第一批统计任务",
    "data_source": "student_assessments",
    "config": {
        "include_dimensions": ["academic", "non_academic"],
        "calculation_types": ["descriptive", "correlation"]
    }
}

// 任务状态响应
{
    "task_id": "uuid-task-id",
    "batch_code": "BATCH_2025_001",
    "status": "processing",
    "progress": 65.5,
    "started_at": "2025-09-04T10:00:00Z",
    "estimated_completion": "2025-09-04T10:15:00Z",
    "error_message": null
}

// 进度详情响应
{
    "task_id": "uuid-task-id",
    "overall_progress": 65.5,
    "stage_details": [
        {
            "stage": "data_loading",
            "status": "completed",
            "progress": 100.0
        },
        {
            "stage": "statistical_calculation", 
            "status": "processing",
            "progress": 45.2
        },
        {
            "stage": "result_aggregation",
            "status": "pending",
            "progress": 0.0
        }
    ]
}
```

## Status Management
```php
// 任务状态枚举
const TASK_STATUSES = [
    'pending'    => '待执行',    // 任务已创建，等待执行
    'processing' => '执行中',    // 任务正在执行
    'completed'  => '已完成',    // 任务执行成功
    'failed'     => '失败',      // 任务执行失败
    'cancelled'  => '已取消'     // 任务被用户取消
];

// 状态流转规则
const STATUS_TRANSITIONS = [
    'pending' => ['processing', 'cancelled'],
    'processing' => ['completed', 'failed', 'cancelled'], 
    'completed' => [],
    'failed' => ['pending'],     // 失败任务可重新执行
    'cancelled' => ['pending']   // 取消任务可重新执行
];
```

## Error Handling
- 状态冲突：处理并发状态更新的冲突情况
- 超时处理：长时间无响应任务的超时机制
- 重试策略：失败任务的自动重试和手动重试
- 错误分类：区分系统错误、数据错误、配置错误等
- 恢复机制：任务中断后的断点续传功能

## Security Features
```php
// API访问控制
const API_PERMISSIONS = [
    'statistics.batch.create' => '创建统计批次',
    'statistics.batch.view'   => '查看统计批次',
    'statistics.batch.update' => '更新统计批次',
    'statistics.batch.delete' => '删除统计批次',
    'statistics.task.start'   => '启动统计任务',
    'statistics.task.cancel'  => '取消统计任务'
];
```

## Monitoring & Logging
- 操作日志：记录所有API调用和状态变更
- 性能监控：API响应时间和任务执行时长监控
- 异常告警：任务失败和异常状态的告警机制
- 资源监控：系统资源使用情况的实时监控

## Dependencies
- [ ] 任务003完成：基础统计计算引擎可用于任务执行
- [ ] 队列系统配置完成(Redis/Database)
- [ ] 用户权限系统集成
- [ ] API文档和前端接口约定确认

## Effort Estimate
- Size: L
- Hours: 20-32小时  
- Parallel: true (可与008并行开发，共同支持业务集成)

## Definition of Done
- [ ] 代码实现完成：所有API接口和任务管理功能
- [ ] CRUD接口测试：批次管理的完整功能测试
- [ ] 状态管理测试：任务状态流转的正确性测试
- [ ] 异步处理测试：任务队列和异步执行测试
- [ ] 并发安全测试：多用户同时操作的安全性测试
- [ ] 错误恢复测试：各种异常情况的处理测试
- [ ] 性能压力测试：大量并发任务的性能测试
- [ ] API文档完成：接口文档和使用示例
- [ ] 安全评审：API安全性和权限控制评审