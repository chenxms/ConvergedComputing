---
name: JSON数据结构
status: open
created: 2025-09-04T19:20:00Z
updated: 2025-09-04T19:20:00Z
github: [Will be updated when synced to GitHub]
depends_on: [008, 009]
parallel: false
conflicts_with: []
---

# Task: JSON数据结构

## Description
实现统计结果的标准化JSON序列化系统，严格遵循json-data-specification.md规范，为前端雷达图和数据可视化提供标准化数据格式。支持区域级和学校级统计数据的完整序列化，包含雷达图专用数据结构和排名对比信息。

## Acceptance Criteria
- [ ] 严格遵循json-data-specification.md的数据格式规范
- [ ] 实现区域级统计数据JSON序列化：包含所有维度的得分率和排名信息
- [ ] 实现学校级统计数据JSON序列化：包含学校与区域对比数据
- [ ] 生成前端雷达图专用数据格式：academic_dimensions和non_academic_dimensions
- [ ] 支持排名数据序列化：区域排名和学校排名的完整信息
- [ ] 实现数据版本控制：支持JSON Schema版本标识和兼容性

## Technical Details
- 数据规范：严格按照已定义的JSON Schema进行序列化
- 雷达图格式：为前端图表组件提供标准化的数据接口
- 版本管理：JSON数据的版本标识和向后兼容性保证
- 数据验证：序列化结果的格式验证和完整性检查
- 性能优化：大数据量序列化的性能优化策略
- 涉及文件：app/Services/Serialization/StatisticsDataSerializer.php, app/Schemas/StatisticsJsonSchema.php

## JSON Schema Compliance
```php
// 必须遵循的核心数据结构
const REQUIRED_SCHEMA_FIELDS = [
    // 区域级数据必填字段
    'regional' => [
        'data_version', 'schema_version', 'batch_code',
        'regional_info', 'academic_statistics', 'non_academic_statistics', 
        'radar_chart_data'
    ],
    
    // 学校级数据必填字段  
    'school' => [
        'data_version', 'schema_version', 'batch_code',
        'school_info', 'regional_info', 'academic_statistics',
        'non_academic_statistics', 'radar_chart_data'
    ]
];

// 雷达图数据必需结构
const RADAR_CHART_STRUCTURE = [
    'academic_dimensions' => [
        'dimension_name', 'score_rate', 'max_rate'  // 区域级
        // OR 'school_score_rate', 'regional_score_rate', 'max_rate'  // 学校级
    ],
    'non_academic_dimensions' => [
        'dimension_name', 'score_rate', 'max_rate'  // 区域级  
        // OR 'school_score_rate', 'regional_score_rate', 'max_rate'  // 学校级
    ]
];
```

## Regional Data Format
```json
{
  "data_version": "1.0",
  "schema_version": "2025-09-04", 
  "batch_code": "BATCH_2025_001",
  "regional_info": {
    "region_code": "BJ_HDN",
    "region_name": "北京市海淀区"
  },
  "academic_statistics": {
    "mathematics": {
      "total_score": 850.5,
      "score_rate": 0.8125,
      "ranking_info": {
        "regional_ranking": 1,
        "regional_ranking_avg": 0.752
      }
    }
  },
  "radar_chart_data": {
    "academic_dimensions": [
      {
        "dimension_name": "数学运算",
        "score_rate": 0.8125,
        "max_rate": 1.0
      }
    ],
    "non_academic_dimensions": [
      {
        "dimension_name": "好奇心", 
        "score_rate": 0.82,
        "max_rate": 1.0
      }
    ]
  }
}
```

## School Data Format  
```json
{
  "data_version": "1.0",
  "schema_version": "2025-09-04",
  "batch_code": "BATCH_2025_001", 
  "school_info": {
    "school_id": "BJ_HDN_001",
    "school_name": "海淀实验小学"
  },
  "radar_chart_data": {
    "academic_dimensions": [
      {
        "dimension_name": "数学运算",
        "school_score_rate": 0.87,
        "regional_score_rate": 0.8125, 
        "max_rate": 1.0
      }
    ],
    "non_academic_dimensions": [
      {
        "dimension_name": "好奇心",
        "school_score_rate": 0.848,
        "regional_score_rate": 0.82,
        "max_rate": 1.0
      }
    ]
  }
}
```

## Serialization Pipeline
- 数据收集：从统计计算结果中提取所需数据
- 格式转换：将统计数据转换为JSON Schema规定格式
- 雷达图处理：生成前端雷达图专用的数据结构  
- 排名计算：计算并填充排名信息
- 验证检查：确保生成的JSON符合Schema规范
- 版本标识：添加数据版本和Schema版本信息

## Data Validation Rules
```php
// JSON格式验证规则
const VALIDATION_RULES = [
    'score_rate_range' => [0.0, 1.0],           // 得分率必须在0-1之间
    'max_rate_value' => 1.0,                    // 雷达图最大值固定为1.0
    'required_dimensions' => [                   // 必需的维度
        'academic' => ['数学运算', '逻辑推理', '阅读理解'],
        'non_academic' => ['好奇心', '观察能力']
    ],
    'batch_code_format' => '/^BATCH_\d{4}_\d{3}$/' // 批次代码格式验证
];

// Schema版本兼容性检查
const SCHEMA_COMPATIBILITY = [
    '2025-09-04' => [
        'supported_versions' => ['1.0'],
        'deprecated_fields' => [],
        'breaking_changes' => []
    ]
];
```

## Performance Optimization
- 数据缓存：缓存频繁访问的统计结果JSON
- 批量序列化：支持批量数据的高效序列化
- 内存管理：大数据量序列化的内存使用优化
- 并行处理：多线程并行序列化提高性能

## Error Handling
- Schema违规：处理不符合规范的数据序列化
- 数据缺失：处理必填字段缺失的情况
- 格式错误：处理数据类型不匹配的问题
- 版本冲突：处理Schema版本不兼容的情况

## Integration Points
```php
// 与其他任务的集成点
const INTEGRATION_DEPENDENCIES = [
    '008_survey_processing' => [
        'non_academic_dimensions',  // 问卷数据的维度得分
        'survey_statistics'         // 问卷统计结果
    ],
    '009_task_management' => [
        'batch_code',              // 任务批次信息
        'processing_metadata'       // 任务执行元数据
    ],
    'statistical_calculations' => [
        'academic_dimensions',      // 学业维度统计结果
        'ranking_data'             // 排名计算结果
    ]
];
```

## Dependencies
- [ ] 任务008完成：问卷数据处理提供非学业维度数据
- [ ] 任务009完成：任务管理API提供批次和元数据信息
- [ ] json-data-specification.md规范确认和锁定
- [ ] 前端雷达图组件的数据格式需求确认
- [ ] JSON Schema验证工具集成

## Effort Estimate
- Size: M
- Hours: 12-20小时
- Parallel: false (依赖008和009的输出数据)

## Definition of Done
- [ ] 代码实现完成：完整的JSON序列化系统
- [ ] Schema遵循测试：严格按照json-data-specification.md规范
- [ ] 区域数据测试：区域级JSON格式的正确性验证
- [ ] 学校数据测试：学校级JSON格式和对比数据验证
- [ ] 雷达图数据测试：前端雷达图数据格式验证
- [ ] 版本兼容测试：JSON版本控制和向后兼容性测试
- [ ] 性能压力测试：大量数据序列化的性能测试  
- [ ] 集成测试：与前端组件的集成验证
- [ ] 文档完成：JSON数据格式使用指南和示例
- [ ] 前端评审：前端开发团队的数据格式确认