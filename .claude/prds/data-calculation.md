---
name: data-calculation
description: 学业发展质量监测数据统计分析与汇聚计算服务
status: backlog
created: 2025-09-04T17:49:59Z
---

# PRD: data-calculation

## 执行概要

data-calculation功能是ConvergedComputing平台的核心统计分析引擎，专门用于处理学业发展质量监测的海量答题数据。该服务能够基于学生在各科目下每道题目的分数，按照教育统计学标准进行区域级和学校级的多维度统计计算，并将结果结构化存储，为前端报告系统提供高质量的数据支持。

**核心价值主张：** 将学生原始答题数据转化为具有教育价值的统计洞察，支持教育决策者进行数据驱动的质量评估和改进。

## 问题陈述

**核心问题：** 
- 海量学生答题数据（存储在student_score_detail表）缺乏有效的统计分析手段
- 需要按照教育统计学标准计算难度、区分度、百分位数等专业指标
- 缺乏批次级别的自动化数据汇聚和多层次统计分析能力
- 原始答题分数无法直接支撑教育质量评估决策

**为什么现在重要：**
- 教育数据驱动决策的迫切需求
- 大规模教育质量监测项目的统计分析瓶颈
- 需要标准化的教育统计指标计算和存储机制

## 用户故事

### 主要用户角色
1. **教育管理员** - 需要手动触发统计计算任务，监控计算状态
2. **教育数据分析师** - 需要获取标准化的教育统计指标和报告
3. **系统集成开发者** - 需要通过API获取计算结果供前端报告系统使用

### 详细用户旅程

**作为教育管理员，我希望能够：**
- 查看系统中所有评测批次的列表和状态
- 手动触发指定批次的统计汇聚计算任务
- 实时监控计算任务的进度和状态
- 在数据问题时删除特定批次的科目数据
- 获得计算完成的确认和结果概览

**作为教育数据分析师，我希望能够：**
- 获取按批次组织的区域级统计报告（平均分、难度、区分度、等级分布）
- 获取学校级对标分析报告（排名、百分位数、标准差等）
- 查看基于维度的细分统计数据
- 验证计算结果的准确性和完整性
- 导出结构化的统计数据用于进一步分析

**作为系统集成开发者，我希望能够：**
- 通过标准化的RESTful API获取统计结果
- 获得JSON格式的结构化数据响应
- 处理API调用的异常和错误情况
- 集成计算状态查询功能
- 实现与前端报告系统的无缝对接

### 解决的痛点
- 海量教育数据无法高效进行统计分析
- 缺乏标准化的教育统计指标计算规范
- 多层次数据汇聚（学校级→区域级）流程复杂
- 手动统计易出错且无法应对大规模数据

## 需求规格

### 功能性需求

**FR1: 区域级学业发展统计计算**

* **FR1.1 科目总体统计**: 系统必须计算指定批次下所有学业科目的区域平均分，并计算各校学业质量总分（各学业科目平均分之和）的全区排名
* **FR1.2 科目难度计算**: 对考试类科目计算难度系数（全区平均分 / 科目满分），科目满分从subject_question_config表的max_score字段汇总计算
* **FR1.3 科目区分度计算**: 对考试类科目计算区分度（前27%学生平均分 - 后27%学生平均分）/ 科目满分），科目满分从subject_question_config表的max_score字段汇总计算
* **FR1.4 等级分布统计**: 按学段标准计算全区学生各科目等级分布比例，基于得分率（平均分/总分）进行等级划分：
  - 初中(7-9th_grade)：优秀(得分率≥80%)、良好(70%≤得分率<80%)、及格(60%≤得分率<70%)、不及格(得分率<60%)
  - 小学(1-6th_grade)：优秀(得分率≥85%)、良好(70%≤得分率<85%)、及格(60%≤得分率<70%)、不及格(得分率<60%)
  - 年级判断基于grade_aggregation_main.grade_level字段
  - 总分从subject_question_config.max_score汇总计算
* **FR1.5 维度统计计算**: 基于question_dimension_mapping表计算各科目下所有核心素养维度的区域平均分和得分率：
  - 维度平均分：基于维度内题目分数的平均值
  - 维度得分率：维度平均分 / 维度总分（维度内所有题目max_score之和）
  - 存储维度得分率供前端雷达图使用

**FR2: 学校级学业发展对标统计**

* **FR2.1 学校基础统计**: 计算各学校在各科目的平均分、标准差、最高分、最低分、得分率，并提供全区排名
  - 学校科目得分率 = 学校科目平均分 / 科目总分
* **FR2.2 学校等级分布**: 计算各学校内部等级分布比例，基于学生个人得分率进行等级划分，与区域数据对标
* **FR2.3 百分位数计算**: 计算各学校学生成绩的P10、P50、P90百分位数分数
  - P10: 得分从高到低排序，前10%位置学生的分数（位置取整数）
  - P50: 得分从高到低排序，中位数（50%位置学生的分数）
  - P90: 得分从高到低排序，90%位置学生的分数（位置取整数）
  - 位置计算: floor(学生总数 × 百分位) 对应位置的学生分数
* **FR2.4 学校维度统计**: 计算各学校在核心素养维度上的平均分和得分率，与区域对标
  - 学校维度得分率 = 学校维度平均分 / 维度总分
  - 存储学校维度得分率供前端雷达图对比使用

**FR3: 区域级非学业发展统计计算**

* **FR3.1 参与度统计**: 统计参与非学业发展评测的学校总数和学生总数
* **FR3.2 问卷类维度统计**: 计算各维度（好奇心、想象力等）的区域平均分和得分率，处理正向/反向量表转换
  - 问卷维度得分率 = 维度平均分 / 维度总分（基于量表满分）
* **FR3.3 问卷选项频率**: 计算每个维度下每道题目各选项的选择比例和频率
* **FR3.4 人机交互统计**: 计算区域平均分和得分率，以及各子能力维度的区域平均得分率
  - 人机交互得分率 = 平均分 / 总分

**FR4: 学校级非学业发展对标统计**

* **FR4.1 学校参与统计**: 统计各学校参与评测的有效学生人数
* **FR4.2 问卷类学校统计**: 计算各学校在每个维度上的平均分和得分率并提供全区排名
  - 学校问卷维度得分率 = 学校维度平均分 / 维度总分
* **FR4.3 人机交互学校统计**: 计算各学校的平均分、得分率、标准差、最高分、最低分
  - 学校人机交互得分率 = 学校平均分 / 总分
* **FR4.4 学校维度得分率**: 计算各学校在每个子能力维度上的得分率，存储供前端雷达图使用
* **FR4.5 学校百分位数**: 计算各学校成绩的P10、P50、P90百分位数分数
  - 计算逻辑同FR2.3，基于学校内学生分数从高到低排序
  - 适用于人机交互类科目的百分位数统计

**FR5: 手动任务管理API**

* **FR5.1 批次列表查询**: 提供API获取grade_aggregation_main表中所有评测批次列表
* **FR5.2 批次详情查询**: 提供API输入batch_code查询批次详细信息和科目状态
* **FR5.3 手动触发计算**: 提供API端点手动触发指定批次的异步统计汇聚任务
* **FR5.4 科目数据删除**: 提供API删除指定批次中某个科目的相关数据（仅限pending状态）
* **FR5.5 任务状态查询**: 提供API从statistics_task_status表查询计算任务的实时状态和进度

**FR6: 数据存储和持久化**

* **FR6.1 学校级结果存储**: 将所有学校级统计结果结构化存入school_statistics_summary表的JSON字段，必须包含：
  - 科目和维度的平均分、得分率
  - 基于subject_question_config.max_score计算的满分信息
  - 供前端雷达图使用的维度得分率数据
* **FR6.2 区域级结果存储**: 将所有区域级统计结果结构化存入regional_statistics_summary表的JSON字段，必须包含：
  - 科目和维度的满分配置信息
  - 区域级得分率统计数据
  - 等级分布统计（基于得分率）
* **FR6.3 任务状态记录**: 在statistics_task_status表记录计算任务状态、进度和错误信息
* **FR6.4 满分配置关联**: 确保所有统计结果都正确关联对应的题目满分配置，支持满分变更的历史追溯

### 非功能性需求

**NFR1 (性能要求)**
- API接口响应时间在正常负载下应低于500毫秒
- 支持单批次最大10万学生数据的统计计算
- 统计汇聚任务完成时间不超过批次数据量的合理范围
- 支持同时处理3个批次的并发计算任务

**NFR2 (可靠性要求)**
- 后台批量计算任务必须支持失败重试机制
- 在statistics_task_status表中记录详细的错误信息和堆栈跟踪
- 计算过程中的异常必须不影响原始数据的完整性
- 提供计算任务的取消和恢复机制

**NFR3 (准确性要求)**
- 所有统计计算必须使用精确的数学公式，并经过样本数据验证
- 计算结果精度保持到小数点后4位
- 等级分布、百分位数等关键指标计算误差率 < 0.01%
- 提供计算结果的一致性验证机制

**NFR4 (可维护性要求)**
- 核心计算逻辑必须与数据访问层分离
- 所有统计公式实现必须编写单元测试
- 代码覆盖率要求 > 90%
- 提供详细的API文档和计算公式说明

## 成功标准

### 可衡量结果
1. **功能完整性指标**
   - 所有FR1-FR6功能需求100%实现
   - 支持三种科目类型（考试类、人机交互类、问卷类）的统计计算
   - 区域级和学校级统计指标计算全覆盖
   - API端点功能验证100%通过

2. **计算准确性指标**
   - 统计公式计算结果与教育统计学标准100%一致
   - 样本数据验证通过率 > 99.9%
   - 计算结果与手工验证数据误差 < 0.01%
   - 跨批次数据一致性验证通过

3. **系统性能指标**
   - 单批次10万学生数据汇聚完成时间 < 30分钟
   - API响应时间95%分位数 < 500毫秒
   - 系统错误率 < 0.1%
   - 并发处理3个批次任务无性能下降

### 关键指标和KPI
- 每批次统计汇聚任务成功率 > 99.5%
- 计算结果JSON存储格式规范性100%
- API调用成功率 > 99.9%
- 统计指标计算覆盖率100%（所有定义的指标均能正确计算）

## 约束与假设

### 技术约束
- **架构约束**: 必须基于现有FastAPI + SQLAlchemy 2.0架构构建
- **数据库约束**: 使用现有MySQL 8.4.6数据库，不能修改核心表结构
- **存储约束**: 统计结果必须存储在指定的JSON字段中，不能创建新的汇总表
- **计算约束**: 使用Pandas + NumPy技术栈进行数据处理和统计计算

### 时间约束
- **MVP交付**: 6周内完成核心统计汇聚功能
- **API完善**: 8周内完成所有管理和查询API
- **测试验证**: 2周内完成计算准确性验证和性能测试
- **部署上线**: 总体项目周期控制在3个月内

### 资源限制
- **开发资源**: 2名后端工程师，1名负责计算引擎，1名负责API开发
- **测试资源**: 依赖现有数据库中的真实数据进行测试验证
- **部署资源**: 使用Docker容器化部署，与现有服务共享基础设施

### 数据假设
- **数据完整性**: 假设student_score_detail表中的数据已完整导入且格式正确
- **维度映射**: 假设question_dimension_mapping表中的题目维度映射关系已正确配置
- **批次管理**: 假设grade_aggregation_main表中的批次信息准确且状态管理正常
- **年级信息**: 假设grade_aggregation_main.grade_level字段准确标识年级（1-6th_grade为小学，7-9th_grade为初中）
- **计算规模**: 假设单批次学生数据量不超过10万条记录

## 超出范围

明确不包含在此版本的功能：

1. **数据导入导出功能**
   - CSV/Excel数据导入接口
   - 统计结果导出为文件格式
   - 数据备份和恢复功能

2. **高级分析功能** 
   - 预测性分析和趋势预测
   - 机器学习算法应用
   - 跨批次对比分析

3. **用户界面功能**
   - Web管理界面开发
   - 计算任务监控仪表板
   - 统计结果可视化展示

4. **企业级运维功能**
   - 详细的系统监控和告警
   - 性能调优和资源管理
   - 多环境部署管理

5. **扩展性功能**
   - 自定义统计公式配置界面
   - 动态维度定义管理
   - 第三方系统API集成

## 依赖关系

### 数据依赖
1. **核心数据表**
   - `student_score_detail`: 学生答题原始数据（必须完整且格式正确）
   - `subject_question_config`: 题目配置和满分信息（max_score字段，所有满分计算的基础数据）
   - `question_dimension_mapping`: 题目维度映射关系（必须预先配置）
   - `batch_dimension_definition`: 批次维度定义（必须包含权重信息）
   - `grade_aggregation_main`: 批次管理信息（状态管理依赖）

2. **配置数据**
   - 学段等级划分标准（小学/初中不同阈值）
   - 科目类型定义（考试类/人机交互类/问卷类）
   - 正向/反向量表配置

### 技术依赖
1. **核心技术栈**
   - Python 3.11+ 运行环境
   - FastAPI框架（用于API开发）
   - SQLAlchemy 2.0（数据访问层）
   - Pandas + NumPy（统计计算引擎）

2. **数据库环境**
   - MySQL 8.4.6数据库服务
   - 现有appraisal_test数据库访问权限
   - JSON字段存储支持

3. **开发工具**
   - Docker容器化环境
   - 现有的开发和部署流程

### 业务依赖
1. **数据质量保证**
   - 数据导入团队确保原始数据完整性
   - 业务团队确认统计计算规则和公式
   - 测试团队提供样本数据和验证标准

2. **接口对接**
   - 前端报告系统对API接口的适配
   - 现有系统对新增JSON数据格式的支持

## 验收测试标准

### 计算准确性验证
1. **样本数据验证**: 使用小规模已知结果的样本数据验证所有统计公式
2. **满分配置验证**: 验证从subject_question_config表正确提取max_score并汇总科目和维度满分
3. **得分率计算验证**: 重点验证所有得分率计算（平均分/总分）的准确性，包括：
   - 科目得分率计算
   - 维度得分率计算
   - 等级分布基于得分率的正确划分
   - 雷达图数据格式的正确性
4. **百分位数计算验证**: 验证P10、P50、P90百分位数计算的准确性：
   - 学生分数从高到低正确排序
   - 位置计算: floor(学生总数 × 百分位) 的正确性
   - 边界情况处理（如学生数量很少的情况）
5. **边界条件测试**: 验证极端数据情况下的计算稳定性
6. **一致性验证**: 确保同一批次多次计算结果完全一致
7. **跨验证**: 与Excel等工具的手工计算结果进行对比验证

### API功能验证
1. **管理API测试**: 通过Postman脚本验证所有管理端点功能
2. **查询API测试**: 验证统计结果查询API返回数据的完整性和格式
3. **异常处理测试**: 验证错误情况下的API响应和错误信息
4. **并发测试**: 验证多批次并发计算的系统稳定性

### 交付标准
- **功能完整性**: 所有FR1-FR6需求100%实现并通过验证
- **数据完整性**: 统计结果JSON数据格式规范且内容完整
- **性能达标**: 满足所有NFR性能和可靠性要求
- **文档齐全**: 提供完整的API文档和计算公式说明